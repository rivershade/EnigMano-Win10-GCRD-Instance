name: GCRD Automation
on:
  workflow_dispatch:
    inputs:
      CODE:
        description: "Headless command or 4/... token"
        required: true
      PIN:
        description: "CRD PIN (6+ digits, optional if secret PIN is set)"
        required: false
        default: ""
      RETRIES:
        description: "Retries"
        default: "3"
permissions:
  contents: read
jobs:
  gcrd-register:
    name: GCRD Register
    runs-on: windows-2022
    env:
      RAW_CODE: ${{ github.event.inputs.CODE }}
      PIN_INPUT: ${{ github.event.inputs.PIN != '' && github.event.inputs.PIN || secrets.PIN }}
      RETRIES_INPUT: ${{ github.event.inputs.RETRIES }}
    defaults:
      run:
        shell: pwsh
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      - name: Validate PIN
        run: |
          $pin = "${{ env.PIN_INPUT }}"
          if ([string]::IsNullOrWhiteSpace($pin)) {
            Write-Error "No PIN provided. Set the repository secret 'PIN' or provide a PIN in the workflow dispatch input."
            exit 1
          }
          if ($pin.Length -lt 6 -or -not ($pin -match '^\d+$')) {
            Write-Error "Invalid PIN. It must be at least 6 digits and numeric only."
            exit 1
          }
          Write-Host "PIN is set and valid."
      - name: Download Assets
        run: |
          $ErrorActionPreference = 'Stop'
          $ProgressPreference = 'SilentlyContinue'
          [Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12
          $dl = "$env:USERPROFILE\Downloads"
          New-Item -ItemType Directory -Path $dl -Force | Out-Null
          $assets = @(
            @{ Url = "https://dl.google.com/edgedl/chrome-remote-desktop/chromeremotedesktophost.msi"; Name = "crdhost.msi" },
            @{ Url = "https://download.vb-audio.com/Download_CABLE/VBCABLE_Driver_Pack45.zip"; Name = "VBCABLE.zip" }
          )
          $retries = 3
          if ($env:RETRIES_INPUT) { try { $retries = [int]$env:RETRIES_INPUT } catch {} }
          $attempts = [Math]::Max(3, $retries)
          foreach ($a in $assets) {
            $dest = "$dl\$($a.Name)"
            Write-Host "Downloading $($a.Name) to $dest..."
            for ($i=1; $i -le $attempts; $i++) {
              try {
                Invoke-WebRequest -Uri $a.Url -OutFile $dest -UseBasicParsing -TimeoutSec 120
                if ((Get-Item $dest).Length -gt 0) { break }
                throw "Empty file"
              } catch {
                if ($i -eq $attempts) { Write-Error "Failed to download $($a.Name)"; exit 1 }
                Start-Sleep -Seconds ([Math]::Min(20, $i * 2))
              }
            }
          }
          Write-Host "All assets downloaded successfully."
      - name: Run GCRD Setup
        run: |
          $ErrorActionPreference = 'Stop'
          powershell.exe -ExecutionPolicy Bypass -File ".\gcrd.ps1" -Code $env:RAW_CODE -Pin $env:PIN_INPUT -Retries $env:RETRIES_INPUT
